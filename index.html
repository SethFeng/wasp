<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Wasp by SethFeng</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-dark.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/SethFeng/wasp">View On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/SethFeng/wasp/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/SethFeng/wasp/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>Wasp</h1>
          <p>Compact and easy to use, &#39;all-in-one&#39; android network solution</p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/SethFeng">SethFeng</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></span>
        </div>

        <h1>
<a id="介绍" class="anchor" href="#%E4%BB%8B%E7%BB%8D" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>介绍</h1>

<p>通过Wasp库使用HTTP GET方式获取内容的示例介绍Wasp的使用，URL为<a href="https://api.github.com/users/sethfeng/repos">https://api.github.com/users/sethfeng/repos</a>
使用Java interface提供HTTP API：</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">interface</span> <span class="pl-en">GitHubService</span> {
    <span class="pl-k">@GET</span>(<span class="pl-s"><span class="pl-pds">"</span>users/{user}/repos<span class="pl-pds">"</span></span>)
    <span class="pl-k">void</span> <span class="pl-en">listRepos</span>(<span class="pl-k">@Path</span>(<span class="pl-s"><span class="pl-pds">"</span>user<span class="pl-pds">"</span></span>) <span class="pl-smi">String</span> <span class="pl-v">user</span>, 
                  <span class="pl-k">Callback&lt;<span class="pl-k">List&lt;<span class="pl-smi">Repo</span>&gt;</span>&gt;</span> <span class="pl-v">callback</span>);
}</pre></div>

<p>创建Wasp：</p>

<div class="highlight highlight-source-java"><pre><span class="pl-smi">Wasp</span> wasp <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Wasp</span>.<span class="pl-smi">Builder</span>(getContext())
            .setEndpoint(<span class="pl-s"><span class="pl-pds">"</span>https://api.github.com<span class="pl-pds">"</span></span>)
            .build();</pre></div>

<p>创建HTTP service：</p>

<pre><code>GitHubService service = wasp.create(GitHubService.class);
</code></pre>

<p>调用HTTP service里方法发送请求：</p>

<div class="highlight highlight-source-java"><pre>gitHubService<span class="pl-k">.</span>listRepos(<span class="pl-s"><span class="pl-pds">"</span>sethfeng<span class="pl-pds">"</span></span>, <span class="pl-k">new</span> Callback&lt;List&lt;Repo&gt;&gt;{
  <span class="pl-k">@Override</span>
  <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onSuccess</span>(<span class="pl-smi">WaspResponse</span> <span class="pl-v">response</span>, <span class="pl-k">List&lt;<span class="pl-smi">Repo</span>&gt;</span> <span class="pl-v">repo</span>) {
    <span class="pl-c">// do something</span>
  }
  <span class="pl-k">@Override</span>
  <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onError</span>(<span class="pl-smi">WaspError</span> <span class="pl-v">error</span>) {
    <span class="pl-c">// handle error</span>
  }
});</pre></div>

<h1>
<a id="api" class="anchor" href="#api" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>API</h1>

<h2>
<a id="请求方法getpost" class="anchor" href="#%E8%AF%B7%E6%B1%82%E6%96%B9%E6%B3%95getpost" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>请求方法GET/POST</h2>

<p>HTTP请求方法使用注解标识：</p>

<div class="highlight highlight-source-java"><pre>@<span class="pl-c1">GET</span>(<span class="pl-c1">...</span>)</pre></div>

<div class="highlight highlight-source-java"><pre>@<span class="pl-c1">POST</span>(<span class="pl-c1">...</span>)</pre></div>

<h2>
<a id="url组装" class="anchor" href="#url%E7%BB%84%E8%A3%85" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>URL组装</h2>

<p>先来看一个常见的URL组成部分：
<code>http://example.com/index.html?name=sethfeng</code></p>

<pre><code>protocol = http
host = example.com
path = /index.html
query = name=sethfeng
</code></pre>

<p>再看Wasp对各参数的API封装：</p>

<h3>
<a id="--protocol和host" class="anchor" href="#--protocol%E5%92%8Chost" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>- protocol和host</h3>

<p>使用Wasp的<code>EndPoint</code>声明，EndPoint又称baseUrl</p>

<div class="highlight highlight-source-java"><pre><span class="pl-smi">Wasp</span><span class="pl-k">.</span><span class="pl-smi">Builder</span><span class="pl-k">.</span>setEndPoint(protocol <span class="pl-k">+</span> host)</pre></div>

<h3>
<a id="--path" class="anchor" href="#--path" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>- path</h3>

<p>使用注解<code>Path</code>设置path中的参数</p>

<div class="highlight highlight-source-java"><pre>@<span class="pl-c1">GET</span>(<span class="pl-s"><span class="pl-pds">"</span>/repos/{id}<span class="pl-pds">"</span></span>)
<span class="pl-k">void</span> getRepo(@Path(<span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>) <span class="pl-smi">String</span> id, 
            <span class="pl-k">Callback&lt;<span class="pl-smi">Repo</span>&gt;</span> callback);</pre></div>

<p>组装出的url为<code>https://api.github.com/repos/id</code></p>

<h3>
<a id="--query" class="anchor" href="#--query" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>- query</h3>

<p>query参数设置：</p>

<div class="highlight highlight-source-java"><pre>@<span class="pl-c1">GET</span>(<span class="pl-s"><span class="pl-pds">"</span>group/{id}/users<span class="pl-pds">"</span></span>)
<span class="pl-k">void</span> groupList(@Path(<span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>) <span class="pl-k">int</span> id, 
              @Query(<span class="pl-s"><span class="pl-pds">"</span>sort<span class="pl-pds">"</span></span>) <span class="pl-smi">String</span> sort, 
              <span class="pl-k">Callback&lt;<span class="pl-k">List&lt;<span class="pl-smi">User</span>&gt;</span>&gt;</span> callback);</pre></div>

<p>组装出的url为<code>https://api.github.com/repos/id/users?sort=sort</code>
当query参数为多个时，可使用<code>QueryMap</code>替代多个Query：</p>

<div class="highlight highlight-source-java"><pre>@<span class="pl-c1">GET</span>(<span class="pl-s"><span class="pl-pds">"</span>group/{id}/users<span class="pl-pds">"</span></span>)
<span class="pl-k">void</span> groupList(@Path(<span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>) <span class="pl-k">int</span> id, 
              @Query(<span class="pl-s"><span class="pl-pds">"</span>sort<span class="pl-pds">"</span></span>) <span class="pl-smi">String</span> sort, 
              @Query(<span class="pl-s"><span class="pl-pds">"</span>limit<span class="pl-pds">"</span></span>) <span class="pl-k">int</span> limit, 
              <span class="pl-k">Callback&lt;<span class="pl-k">List&lt;<span class="pl-smi">User</span>&gt;</span>&gt;</span> callback);</pre></div>

<p>等同于：</p>

<div class="highlight highlight-source-java"><pre>@<span class="pl-c1">GET</span>(<span class="pl-s"><span class="pl-pds">"</span>group/{id}/users<span class="pl-pds">"</span></span>)
<span class="pl-k">void</span> groupList(@Path(<span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>) <span class="pl-k">int</span> id, 
              @<span class="pl-smi">QueryMap</span> <span class="pl-k">Map&lt;<span class="pl-smi">String</span>, <span class="pl-smi">String</span>&gt;</span> query, 
              <span class="pl-k">Callback&lt;<span class="pl-k">List&lt;<span class="pl-smi">User</span>&gt;</span>&gt;</span> callback);</pre></div>

<p>相应地，query参数要封装成Map传入：</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">HashMap&lt;<span class="pl-smi">String</span>, <span class="pl-smi">String</span>&gt;</span> query <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">HashMap</span>();
query<span class="pl-k">.</span>put(<span class="pl-s"><span class="pl-pds">"</span>sort<span class="pl-pds">"</span></span>, `sort`);
query<span class="pl-k">.</span>put(<span class="pl-s"><span class="pl-pds">"</span>limit<span class="pl-pds">"</span></span>, `limit`);</pre></div>

<p>组装出的url为<code>https://api.github.com/repos/id/users?sort=sort&amp;limit=limit</code></p>

<h2>
<a id="解析器" class="anchor" href="#%E8%A7%A3%E6%9E%90%E5%99%A8" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>解析器</h2>

<p>Wasp默认使用Gson解析网络请求返回数据。若要自定义解析器，传入自定义的解析器。自定义解析器需要实现<code>Parser</code>接口。</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">CustomParser</span> <span class="pl-k">implements</span> <span class="pl-e">Parser</span> {
  <span class="pl-k">@Override</span>
  <span class="pl-k">public</span> <span class="pl-k">&lt;<span class="pl-smi">T</span>&gt;</span> <span class="pl-smi">T</span> <span class="pl-en">fromBody</span>(<span class="pl-smi">String</span> <span class="pl-v">content</span>, <span class="pl-smi">Type</span> <span class="pl-v">type</span>) <span class="pl-k">throws</span> <span class="pl-smi">IOException</span> { <span class="pl-c">// 结果解析</span>
    <span class="pl-c1">...</span>
  }
  <span class="pl-k">@Override</span>
  <span class="pl-k">public</span> <span class="pl-smi">String</span> <span class="pl-en">toBody</span>(<span class="pl-smi">Object</span> <span class="pl-v">body</span>) { <span class="pl-c">// POST body组装</span>
    <span class="pl-c1">...</span>
  }
  <span class="pl-k">@Override</span>
  <span class="pl-k">public</span> <span class="pl-smi">String</span> <span class="pl-en">getSupportedContentType</span>() {
    <span class="pl-c1">...</span>
  }
}</pre></div>

<p>创建Wasp时可设置自定义的解析器：</p>

<pre><code>Wasp wasp = new Wasp.Builder(getContext())
            .setEndpoint("https://api.github.com")
            .setParser(new CustomParser())
            .build();
</code></pre>

<h2>
<a id="post请求" class="anchor" href="#post%E8%AF%B7%E6%B1%82" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>POST请求</h2>

<p>HTTP POST请求需要处理HTTP body。<code>Parser.toBody()</code>可自定义body参数的处理。</p>

<div class="highlight highlight-source-java"><pre>@<span class="pl-c1">POST</span>(<span class="pl-s"><span class="pl-pds">"</span>/repos/{user}/{repo}<span class="pl-pds">"</span></span>)
<span class="pl-k">void</span> addName(@Path(<span class="pl-s"><span class="pl-pds">"</span>user<span class="pl-pds">"</span></span>) <span class="pl-smi">String</span> user,
             @Path(<span class="pl-s"><span class="pl-pds">"</span>repo<span class="pl-pds">"</span></span>) <span class="pl-smi">String</span> repo,
             @<span class="pl-smi">Body</span> <span class="pl-smi">String</span> body,
             <span class="pl-k">Callback&lt;<span class="pl-smi">Repo</span>&gt;</span> callback
);</pre></div>

<p>发送POST请求：</p>

<div class="highlight highlight-source-java"><pre>gitHubService<span class="pl-k">.</span>addName(user, repo, body, callback);</pre></div>

<h2>
<a id="同步异步" class="anchor" href="#%E5%90%8C%E6%AD%A5%E5%BC%82%E6%AD%A5" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>同步/异步</h2>

<p>异步请求使用网络库统一管理网络访问线程。若需要使用同步方式，网络请求在发起请求的线程里执行。请勿在Android主线程使用同步方式。
同步接口不传入回调，直接调用接口方法获取数据。请求接口声明：</p>

<div class="highlight highlight-source-java"><pre>@<span class="pl-c1">GET</span>(<span class="pl-s"><span class="pl-pds">"</span>users/{user}/repos<span class="pl-pds">"</span></span>)
<span class="pl-k">List&lt;<span class="pl-smi">Repo</span>&gt;</span> listRepos(@Path(<span class="pl-s"><span class="pl-pds">"</span>user<span class="pl-pds">"</span></span>) <span class="pl-smi">String</span> user);</pre></div>

<p>发送请求：</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">List&lt;<span class="pl-smi">Repo</span>&gt;</span> repos <span class="pl-k">=</span> gitHubService<span class="pl-k">.</span>listRepos(user);</pre></div>

<h2>
<a id="取消异步请求" class="anchor" href="#%E5%8F%96%E6%B6%88%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>取消异步请求</h2>

<p>在Android界面销毁时可能需要取消已经发送但还未收到结果的网络请求。与异步接口的区别仅在于接口方法返回参数不同：</p>

<div class="highlight highlight-source-java"><pre>@<span class="pl-c1">GET</span>(<span class="pl-s"><span class="pl-pds">"</span>users/{user}/repos<span class="pl-pds">"</span></span>)
<span class="pl-smi">WaspRequest</span> listRepos(@Path(<span class="pl-s"><span class="pl-pds">"</span>user<span class="pl-pds">"</span></span>) <span class="pl-smi">String</span> user, 
                      <span class="pl-k">Callback&lt;<span class="pl-k">List&lt;<span class="pl-smi">Repo</span>&gt;</span>&gt;</span> callback);</pre></div>

<p>发起和取消请求：</p>

<div class="highlight highlight-source-java"><pre><span class="pl-c">// 发起请求</span>
<span class="pl-smi">WaspRequest</span> request <span class="pl-k">=</span> gitHubService<span class="pl-k">.</span>listRepos(user, callback);

<span class="pl-c">// 取消请求</span>
request<span class="pl-k">.</span>cancel();</pre></div>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>
